<!DOCTYPE HTML>
<html>
<head>
<META charset="UTF-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="../../lib/jui/css/ui.min.css" />
<link rel="stylesheet" href="../../lib/jui/css/ui-jennifer.min.css" />
<link rel="stylesheet" href="../../lib/jui/css/grid.min.css" />
<link rel="stylesheet" href="../../lib/jui/css/grid-jennifer.min.css" />
<script type="text/javascript" src="../../lib/jquery-1.8.0.min.js" ></script>
<script type="text/javascript" src="../../lib/jui/js/core.min.js" ></script>
<script type="text/javascript" src="../../lib/jui/js/ui.min.js" ></script>
<script type="text/javascript" src="../../lib/jui/js/grid.min.js" ></script>
<script type="text/javascript" src="../../lib/jui/js/chart.min.js" ></script>
<style>
    body {
        padding: 10px;
    }

    .col-7 {
        padding-left: 15px;
    }

    .navbar {
        margin-bottom: 15px;
    }

    .panel > .body {
        padding: 7px !important;
    }

    #map, #status {
        width: 100%;
        height: 100%;
    }

    #dashboard_top {
        width: 100%;
        height: 60%;
    }

    #dashboard_bottom {
        width: 100%;
        height: 40%;
    }
</style>
<script>
function windowResize() {
    var $panel = $(".panel > .body"),
        h = $(window).height() - 160;

    $($panel.get(0)).height(h);
    $($panel.get(1)).height(h - 160 - 60);
    $($panel.get(2)).height(160);
    $($panel.get(2)).parent().css("top", 5);
}

function randomValue(start, limit) {
    return Math.floor(Math.random() * limit) + start;
}

function pastTimeInterval(min) {
    var time = jui.include("util.time");
    return [ new Date(new Date() - time.MINUTE * min), new Date() ];
}

function getDataForActiveService() {
    var data = [];

    for(var i = 1; i <= 5; i++) {
        data.push({
            server: "W" + i,
            normal: randomValue(0, 20),
            warning: randomValue(0, 10),
            fatal: randomValue(0, 5)
        });
    }

    return data;
}

function getDataForResponseTime(count) {
    var data = [];

    for(var i = 0; i < count; i++) {
        data.push({
            w1: randomValue(4000, 1000),
            w2: randomValue(3000, 1500),
            w3: randomValue(6000, 500),
            w4: randomValue(2000, 750),
            w5: randomValue(7000, 250)
        });
    }

    return data;
}

function getDataForTPS(count) {
    var data = [];

    for(var i = 0; i < count; i++) {
        data.push({
            w1: randomValue(50, 5),
            w2: randomValue(70, 5),
            w3: randomValue(60, 5),
            w4: randomValue(50, 5),
            w5: randomValue(30, 5)
        });
    }

    return data;
}

function setTransactionData(list, domain) {
    var count = Math.floor(Math.random() * 100);

    for(var i = 0; i < list.length; i++) {
        if(list[i].time.getTime() < domain[0].getTime()) {
            list.shift();
        } else {
            break;
        }
    }

    for(var i = 0; i < count; i++) {
        var type = Math.floor(Math.random() * 6),
            data = {
                delay: Math.floor(Math.random() * 10000),
                level: "normal",
                time: domain[1]
            };

        if(type > 2 && type < 5) {
            data.level = "warning";
        } else if(type > 4) {
            data.level = "fatal";
        }

        list.push(data);
    }
}

function getDataForToday(count) {
    var data = [];

    for(var i = 0; i < count; i++) {
        data.push({
            tps: randomValue(50, 5),
            user: randomValue(1000, 100)
        });
    }

    return data;
}

function getTimeToIndex() {
    var now = new Date();
    return now.getHours() * 60 + now.getMinutes();
}

function getDataForHours() {
    var data = [],
        now = new Date();

    for(var i = 0; i < 24; i++) {
        data.push({
            hours: i,
            callcount: randomValue(10000, 2000),
            visitor: randomValue(5000, 1000),
            today: (i <= now.getHours()) ? true : false
        });
    }

    return data;
}

function getDataForWolrdMap() {
    var keys = [ "KR", "CN", "US", "FR", "BR", "AU", "JP", "IN", "RU", "GB" ],
        data = [];

    for(var i = 0; i < keys.length; i++) {
        var value = randomValue(1000, 5000);

        if(keys[i] == "KR") {
            value = randomValue(5000, 1000);
        } else if(keys[i] == "CN" || keys[i] == "RU") {
            value = randomValue(3000, 2000);
        } else if(keys[i] == "JP" || keys[i] == "IN") {
            value = randomValue(2000, 3000);
        }

        data.push({
            id: keys[i], value: value
        });
    }

    return data;
}

function getDataForVisitor() {
    var desktopRate = randomValue(50, 50),
        visits = randomValue(10000, 5000);

    return [
        { title : "Overall Visits", value : visits, max : 15000, min : 0 },
        { title : "Mobile Rate", value : 100 - desktopRate, max : 100, min : 0 },
        { title : "Desktop Rate", value : desktopRate, max : 100, min : 0 }
    ];
}

jui.ready([ "util.base", "util.time", "chart.builder" ], function(_, time, builder) {
    windowResize();

    var dashboard_top = builder("#dashboard_top", {
        padding : 5,
        axis : [{
            x : {
                type : "block",
                domain : "server",
                line : true
            },
            y : {
                type : "range",
                domain : [ 0, 40 ],
                step : 2,
                line : true
            },
            padding : {
                left : 50,
                top : 35,
                right : 20,
                bottom : 20
            },
            area : {
                height: "32%"
            }
        }, {
            extend : 0,
            x : {
                type : "dateblock",
                domain : pastTimeInterval(5),
                interval : 1,
                realtime : "minutes",
                format : "hh:mm",
                line : false
            },
            y : {
                type : "range",
                domain : [ 0, 10000 ],
                step : 2
            },
            area : {
                y : "34%",
                width : "49%"
            }
        }, {
            extend : 1,
            y : {
                type : "range",
                domain : [ 0, 100 ],
                step : 2,
                format : function(d) {
                    return d + "%";
                }
            },
            area : {
                x : "50%",
                width : "50%"
            }
        }, {
            extend : 2,
            x : {
                type : "dateblock",
                domain : [ new Date("2016/01/01"), new Date("2016/01/02") ],
                interval : time.HOUR, // Only milliseconds
                format : function(d, i) {
                    return (i % 2) ? "" : i;
                },
                realtime : false
            },
            y : {
                type : "range",
                domain : [ 0, 100 ],
                step : 2
            },
            area : {
                x : "0%",
                y : "68%",
                width : "49%"
            }
        }, {
            extend : 3,
            y : {
                domain : function(d) {
                    return d.user * 1.3;
                },
                format : null
            },
            area : {
                x : "50%",
                width : "50%"
            }
        }],
        brush : [{
            type : "equalizercolumn",
            target : [ "normal", "warning", "fatal" ],
            innerPadding : 1,
            outerPadding : 20,
            unit : 20,
            colors : [ "#7BBAE7", "#FFC000", "#FF0000" ],
            axis : 0
        }, {
            type : "line",
            target : [ "w1", "w2", "w3", "w4", "w5" ],
            axis : 1
        }, {
            type : "line",
            target : [ "w1", "w2", "w3", "w4", "w5" ],
            axis : 2
        }, {
            type : "splitarea",
            target : [ "tps" ],
            axis : 3
        }, {
            type : "pin",
            axis : 3,
            format : function(d) {
                return time.format(d, "HH:mm");
            }
        }, {
            type : "splitarea",
            target : [ "user" ],
            axis : 4
        }, {
            type : "pin",
            axis : 4,
            format : function(d) {
                return time.format(d, "HH:mm");
            }
        }],
        widget : [{
            type : "title",
            text : "Active Service",
            dx : -10,
            dy : -7,
            axis : 0,
            align : "start"
        }, {
            type : "title",
            text : "Response Time",
            dx : -10,
            dy : -7,
            axis : 1,
            align : "start"
        }, {
            type : "title",
            text : "TPS",
            dx : -10,
            dy : -7,
            axis : 2,
            align : "start"
        }, {
            type : "title",
            text : "Today's TPS",
            dx : -10,
            dy : -7,
            axis : 3,
            align : "start"
        }, {
            type : "title",
            text : "Today's concurrent users",
            dx : -10,
            dy : -7,
            axis : 4,
            align : "start"
        }, {
            type : "tooltip",
            brush : [ 1, 2 ]
        }, {
            type : "cross",
            xFormat : function(d) {
                return time.format(d, "hh:mm");
            },
            yFormat : function(d) {
                return Math.ceil(d);
            },
            axis : 1
        }, {
            type : "cross",
            xFormat : function(d) {
                return time.format(d, "hh:mm");
            },
            yFormat : function(d) {
                return Math.ceil(d);
            },
            axis : 2
        }, {
            type : "cross",
            yFormat : function(d) {
                return Math.ceil(d);
            },
            axis : 3
        }, {
            type : "cross",
            yFormat : function(d) {
                return Math.ceil(d);
            },
            axis : 4
        }],
        style : {
            axisBorderColor : "#dcdcdc",
            axisBorderWidth : 1.5,
            axisBorderRadius : 5,
            titleFontSize : 12,
            titleFontWeight : 700
        },
        render : false
    });

    var dashboard_bottom = builder("#dashboard_bottom", {
        padding : 5,
        axis : [{
            x : {
                type : "block",
                domain : "hours",
                format : function(d, i) {
                    return (d % 2) ? d : "";
                }
            },
            y : {
                type : "range",
                domain : function(d) {
                    return d.callcount * 1.3;
                },
                format : function(d, i) {
                    return Math.ceil(d / 1000) + "K";
                },
                step : 2
            },
            padding : {
                left : 50,
                top : 35,
                right : 20,
                bottom : 20
            },
            area : {
                width : "49%",
                height : "48%"
            }
        }, {
            extend : 0,
            y : {
                domain : function(d) {
                    return d.visitor * 1.3
                }
            },
            area : {
                y : "51%"
            }
        }, {
            extend : 1,
            x : {
                type : "date",
                domain : pastTimeInterval(10),
                interval : 2,
                realtime : "minutes",
                format : "hh:mm",
                key : "time"
            },
            y : {
                type : "range",
                domain : [ 0, 10000 ],
                step : 4,
                format : null
            },
            area : {
                x : "50%",
                y : "0%",
                width : "50%",
                height : "99%"
            }
        }],
        brush : [{
            type : "column",
            target : [ "callcount" ],
            display : "max",
            colors : function(d) {
                return (d.today) ? 0 : "#929292";
            },
            axis : 0
        }, {
            type : "focus",
            start : 0,
            end : 0,
            axis : 0
        }, {
            type : "column",
            target : [ "visitor" ],
            display : "max",
            colors : function(d) {
                return (d.today) ? 0 : "#929292";
            },
            axis : 1
        }, {
            type : "focus",
            start : 0,
            end : 0,
            axis : 1
        }, {
            type : "canvas.scatter",
            symbol : "cross",
            target : [ "delay" ],
            size : 5,
            colors : function(d) {
                if(d.level == "fatal") {
                    return "#ff0000"
                } else if(d.level == "warning") {
                    return "#f2ab14";
                }

                return "#4692ca";
            },
            clip : true,
            axis : 2
        }],
        widget : [{
            type : "title",
            text : "Hourly call count",
            dx : -10,
            dy : -7,
            axis : 0,
            align : "start"
        }, {
            type : "title",
            text : "Hourly visitor",
            dx : -10,
            dy : -7,
            axis : 1,
            align : "start"
        }, {
            type : "title",
            text : "X-View",
            dx : -10,
            dy : -7,
            axis : 2,
            align : "start"
        }],
        style : {
            axisBorderColor : "#dcdcdc",
            axisBorderWidth : 1.5,
            axisBorderRadius : 5,
            titleFontSize : 12,
            titleFontWeight : 700
        },
        event : {
            "dragselect.end": function(data) {
                alert(data.length);
                console.log(data);
            }
        },
        render : false,
        canvas : true
    });

    var map = builder("#map", {
        padding : 0,
        axis : [{
            map : {
                path : "../../lib/jui/img/map/world-1040x660.svg",
                width : 1040,
                height : 630,
                scale : 1.5
            }
        }],
        brush : [{
            type : "map.bubble",
            min : 5,
            max : 50,
            showText : true,
            colors : function(d) {
                if(d.value > 5000) {
                    return "linear(top) #ff686c,0.9 #fa5559";
                } else if(d.value > 3000) {
                    return "linear(top) #ff9d46,0.9 #ff7800";
                } else if(d.value > 1000) {
                    return "linear(top) #b76fef,0.9 #9228e4";
                }

                return "linear(top) #9694e0,0.9 #7977C2";
            }
        }, {
            type : "map.selector",
            activeEvent : "map.click"
        }],
        widget : [{
            type : "map.control",
            align : "start",
            orient : "top",
            dx : 10,
            dy : 10
        }, {
            type : "map.tooltip",
            format : function(obj) {
                if(obj.data.id == "KR") {
                    return "Korea";
                }

                return obj.data.id;
            }
        }],
        style: {
            mapPathBorderWidth: 0.3
        }
    });

    var status = builder("#status", {
        padding : {
            top : 25,
            bottom : 25,
            right : 25,
            left : 50
        },
        axis : [{
            c : {
                type : "table",
                rows : 1,
                columns : 3,
                padding : 10
            },
            data : getDataForVisitor()
        }],
        brush : [{
            type : "fullgauge",
            size : 10,
            titleX : -55,
            format : function(value, index) {
                if(index == 0) {
                    return Math.round(value / 1000) + "K";
                }

                return value + "%";
            }
        }]
    });

    _.resize(windowResize, 100);

    // Data update
    setInterval(function() {
        var domain = pastTimeInterval(5);

        // 1. Active Service
        dashboard_top.axis(0).update(getDataForActiveService());

        // 2. Response Time
        var responseTimeData = dashboard_top.axis(1).data;
        dashboard_top.axis(1).set("x", { domain: domain });

        if(responseTimeData.length == 0) {
            dashboard_top.axis(1).update(getDataForResponseTime(300));
        } else if(responseTimeData.length == 300) {
            responseTimeData.shift();
            responseTimeData.push(getDataForResponseTime(1)[0]);
            dashboard_top.axis(1).update(responseTimeData);
        }

        // 3. TPS
        var tpsData = dashboard_top.axis(2).data;
        dashboard_top.axis(2).set("x", { domain: domain });

        if(tpsData.length == 0) {
            dashboard_top.axis(2).update(getDataForTPS(300));
        } else if(tpsData.length == 300) {
            tpsData.shift();
            tpsData.push(getDataForTPS(1)[0]);
            dashboard_top.axis(2).update(tpsData);
        }

        // 4. Today's TPS & User
        var todaysTpsData = dashboard_top.axis(3).data,
            todaysUserData = dashboard_top.axis(4).data,
            splitIndex = getTimeToIndex();

        if(todaysTpsData.length == 0) {
            dashboard_top.axis(3).update(getDataForToday(1440));
            dashboard_top.axis(4).update(getDataForToday(1440));
        } else if(todaysTpsData.length == 1440) {
            if(domain[1].getSeconds() == 0) {
                var data = getDataForToday(1)[0];

                todaysTpsData.shift();
                todaysTpsData.push(data);
                todaysUserData.shift();
                todaysUserData.push(data);

                dashboard_top.axis(3).update(todaysTpsData);
                dashboard_top.axis(4).update(todaysUserData);
            }
        }

        dashboard_top.updateBrush(3, { split: splitIndex });
        dashboard_top.updateBrush(4, { split: splitIndex });
        dashboard_top.updateBrush(5, { split: splitIndex });
        dashboard_top.updateBrush(6, { split: splitIndex });

        // Chart rendering
        dashboard_top.render();
    }, 1000);

    setInterval(function() {
        var domain = pastTimeInterval(10);

        // Call Count & Visitor
        if(dashboard_bottom.axis(0).data.length == 0 || domain[1].getMinutes() == 0) {
            var hoursData = getDataForHours(),
                focusIndex = {
                    start: domain[1].getHours(),
                    end: domain[1].getHours()
                };

            dashboard_bottom.updateBrush(1, focusIndex);
            dashboard_bottom.updateBrush(3, focusIndex);
            dashboard_bottom.axis(0).update(hoursData);
            dashboard_bottom.axis(1).update(hoursData);
        }

        // Transaction
        setTransactionData(dashboard_bottom.axis(2).data, domain);
        dashboard_bottom.axis(2).set("x", { domain: domain });

        dashboard_bottom.render();
    }, 2000);

    setInterval(function() {
        map.axis(0).update(getDataForWolrdMap());
        status.axis(0).update(getDataForVisitor());
    }, 3000);
});
</script>
</head>
<body class="jui">
<div class="navbar">
    <a class="btn small"><i class="icon-search"></i> Mini button</a>
    <a class="btn small"> Mini button</a>
</div>
<div class="row">
    <div class="col" style="width: 49%;">
        <div class="panel">
            <div class="head">
                <strong>System dashboard</strong>
            </div>
            <div class="body">
                <div id="dashboard_top"></div>
                <div id="dashboard_bottom"></div>
            </div>
        </div>
    </div>
    <div class="col" style="left: 1%; width: 50%;">
        <div class="row">
            <div class="panel">
                <div class="head">
                    <strong>Visitor location map</strong>
                </div>
                <div class="body">
                    <div id="map"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="panel">
                <div class="head">
                    <strong>Visitor status</strong>
                </div>
                <div class="body">
                    <div id="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>