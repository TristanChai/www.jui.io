<!DOCTYPE HTML>
<html>
<head>
<META charset="UTF-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="../../lib/jui/css/ui.min.css" />
<link rel="stylesheet" href="../../lib/jui/css/ui-jennifer.min.css" />
<link rel="stylesheet" href="../../lib/jui/css/grid.min.css" />
<link rel="stylesheet" href="../../lib/jui/css/grid-jennifer.min.css" />
<script type="text/javascript" src="../../lib/jquery-1.8.0.min.js" ></script>
<script type="text/javascript" src="../../lib/jui/js/core.min.js" ></script>
<script type="text/javascript" src="../../lib/jui/js/ui.min.js" ></script>
<script type="text/javascript" src="../../lib/jui/js/grid.min.js" ></script>
<script type="text/javascript" src="../../lib/jui/js/chart.min.js" ></script>
<style>
    body {
        padding: 10px;
    }

    .col-7 {
        padding-left: 15px;
    }

    .navbar {
        margin-bottom: 15px;
    }

    .panel > .body {
        padding: 7px !important;
    }

    #dashboard, #map, #status {
        width: 100%;
        height: 100%;
    }
</style>
<script>
function windowResize() {
    var $panel = $(".panel > .body"),
        h = $(window).height() - 160;

    $($panel.get(0)).height(h);
    $($panel.get(1)).height(h - 160 - 60);
    $($panel.get(2)).height(160);
    $($panel.get(2)).parent().css("top", 5);
}

function randomValue(start, limit) {
    return Math.floor(Math.random() * limit) + start;
}

function fiveMinBeforeTime() {
    var time = jui.include("util.time");
    return [ new Date(new Date() - time.MINUTE * 5), new Date() ];
}

function getDataForActiveService() {
    var data = [];

    for(var i = 1; i <= 5; i++) {
        data.push({
            server: "W" + i,
            normal: randomValue(0, 20),
            warning: randomValue(0, 10),
            fatal: randomValue(0, 5)
        });
    }

    return data;
}

function getDataForResponseTime(count) {
    var data = [];

    for(var i = 0; i < count; i++) {
        data.push({
            w1: randomValue(4000, 1000),
            w2: randomValue(3000, 1500),
            w3: randomValue(6000, 500),
            w4: randomValue(2000, 750),
            w5: randomValue(7000, 250)
        });
    }

    return data;
}

function getDataForTPS(count) {
    var data = [];

    for(var i = 0; i < count; i++) {
        data.push({
            w1: randomValue(50, 5),
            w2: randomValue(70, 5),
            w3: randomValue(60, 10),
            w4: randomValue(50, 10),
            w5: randomValue(70, 20)
        });
    }

    return data;
}

function setTransactionData(list, domain) {
    var count = Math.floor(Math.random() * 20);

    for(var i = 0; i < list.length; i++) {
        if(list[i].time.getTime() < domain[0].getTime()) {
            list.shift();
        } else {
            break;
        }
    }

    for(var i = 0; i < count; i++) {
        var type = Math.floor(Math.random() * 6),
            data = {
                delay: Math.floor(Math.random() * 10000),
                level: "normal",
                time: domain[1]
            };

        if(type > 2 && type < 5) {
            data.level = "warning";
        } else if(type > 4) {
            data.level = "fatal";
        }

        list.push(data);
    }
}

jui.ready([ "util.base", "util.time", "chart.builder" ], function(_, time, builder) {
    windowResize();

    var dashboard = builder("#dashboard", {
        padding : 5,
        axis : [{
            x : {
                type : "block",
                domain : "server",
                line : true
            },
            y : {
                type : "range",
                domain : [ 0, 40 ],
                step : 2,
                line : true
            },
            padding : {
                left : 50,
                top : 35,
                right : 20,
                bottom : 20
            },
            area : {
                height: "19%"
            }
        }, {
            extend : 0,
            x : {
                type : "dateblock",
                domain : fiveMinBeforeTime(),
                interval : 1,
                realtime : "minutes",
                format : "hh:mm",
                line : false
            },
            y : {
                type : "range",
                domain : [ 0, 8000 ],
                step : 2
            },
            area : {
                y : "20%",
                width : "49%"
            }
        }, {
            extend : 1,
            y : {
                type : "range",
                domain : [ 0, 100 ],
                step : 2
            },
            area : {
                x : "50%",
                width : "50%"
            }
        }, {
            extend : 2,
            x : {
                type : "dateblock",
                domain : [ new Date("2016/01/01"), new Date("2016/01/02") ],
                interval : time.HOUR, // Only milliseconds
                format : function(d, i) {
                    return i;
                }
            },
            y : {
                type : "range",
                domain : [ 0, 100 ],
                step : 2
            },
            area : {
                x : "0%",
                y : "40%",
                width : "49%"
            }
        }, {
            extend : 3,
            area : {
                x : "50%",
                width : "50%"
            }
        }, {
            x : {
                type : "fullblock",
                domain : "quarter"
            },
            y : {
                type : "range",
                domain : "sales",
                step : 2
            },
            data : [
                { quarter : "00", sales : 50 },
                { quarter : "02", sales : 20 },
                { quarter : "04", sales : 10 },
                { quarter : "06", sales : 30 },
                { quarter : "08", sales : 44 },
                { quarter : "10", sales : 22 },
                { quarter : "12", sales : 21 },
                { quarter : "14", sales : 36 },
                { quarter : "16", sales : 56 },
                { quarter : "18", sales : 30 },
                { quarter : "20", sales : 32 },
                { quarter : "22", sales : 25 },
                { quarter : "24", sales : 22 }
            ],
            padding : {
                left : 50,
                top : 35,
                right : 20,
                bottom : 20
            },
            area : {
                x : "0%",
                y : "60%",
                width : "49%",
                height : "19%"
            }
        }, {
            extend : 5,
            data : [
                { quarter : "00", sales : 50 },
                { quarter : "02", sales : 20 },
                { quarter : "04", sales : 10 },
                { quarter : "06", sales : 30 },
                { quarter : "08", sales : 44 },
                { quarter : "10", sales : 22 },
                { quarter : "12", sales : 21 },
                { quarter : "14", sales : 36 },
                { quarter : "16", sales : 56 },
                { quarter : "18", sales : 30 },
                { quarter : "20", sales : 32 },
                { quarter : "22", sales : 25 },
                { quarter : "24", sales : 22 }
            ],
            area : {
                y : "80%"
            }
        }, {
            extend : 1,
            x : {
                type : "date",
                domain : fiveMinBeforeTime(),
                interval : 1,
                realtime : "minutes",
                format : "hh:mm",
                key : "time"
            },
            y : {
                type : "range",
                domain : [ 0, 8000 ],
                step : 2
            },
            area : {
                x : "50%",
                y : "60%",
                width : "50%",
                height : "39%"
            }
        }],
        brush : [{
            type : "equalizercolumn",
            target : [ "normal", "warning", "fatal" ],
            innerPadding : 1,
            outerPadding : 20,
            unit : 20,
            colors : [ "#7BBAE7", "#FFC000", "#FF0000" ],
            axis : 0
        }, {
            type : "line",
            target : [ "w1", "w2", "w3", "w4", "w5" ],
            axis : 1
        }, {
            type : "scatter",
            target : [ "w1", "w2", "w3", "w4", "w5" ],
            axis : 2
        }, {
            type : "column",
            target : [ "sales" ],
            axis : 5
        }, {
            type : "column",
            target : [ "sales" ],
            axis : 6
        }, {
            type : "canvas.scatter",
            symbol : "cross",
            target : [ "delay" ],
            size : 5,
            colors : function(d) {
                if(d.level == "fatal") {
                    return "#ff0000"
                } else if(d.level == "warning") {
                    return "#f2ab14";
                }

                return "#4692ca";
            },
            clip : true,
            axis : 7
        }],
        widget : [{
            type : "title",
            text : "Active Service",
            dx : -10,
            dy : -7,
            axis : 0,
            align : "start"
        }, {
            type : "title",
            text : "Response Time",
            dx : -10,
            dy : -7,
            axis : 1,
            align : "start"
        }, {
            type : "title",
            text : "TPS",
            dx : -10,
            dy : -7,
            axis : 2,
            align : "start"
        }, {
            type : "title",
            text : "Today's TPS",
            dx : -10,
            dy : -7,
            axis : 3,
            align : "start"
        }, {
            type : "title",
            text : "Today's concurrent users",
            dx : -10,
            dy : -7,
            axis : 4,
            align : "start"
        }, {
            type : "title",
            text : "Hourly call count",
            dx : -10,
            dy : -7,
            axis : 5,
            align : "start"
        }, {
            type : "title",
            text : "Hourly visitor",
            dx : -10,
            dy : -7,
            axis : 6,
            align : "start"
        }, {
            type : "title",
            text : "X-View",
            dx : -10,
            dy : -7,
            axis : 7,
            align : "start"
        }, {
            type : "tooltip",
            brush : [ 1 ]
        }],
        style : {
            axisBorderColor : "#dcdcdc",
            axisBorderWidth : 1.5,
            axisBorderRadius : 5,
            titleFontSize : 12,
            titleFontWeight : 700
        },
        render : false,
        canvas : true
    });

    var map = builder("#map", {
        padding : 0,
        axis : [{
            map : {
                path : "../../lib/jui/img/map/world-1040x660.svg",
                width : 1040,
                height : 630,
                scale : 1.5
            },
            data :  [{
                id: "KR",
                value: 50220000
            }, {
                id: "CN",
                value: 1357000000
            }, {
                id: "US",
                value: 318900000
            }, {
                id: "FR",
                value: 66030000
            }, {
                id: "BR",
                value: 200400000
            }, {
                id: "AU",
                value: 23130000
            }, {
                id: "JP",
                value: 127300000
            }, {
                id: "IN",
                value: 1252000000
            }, {
                id: "RU",
                value: 143500000
            }, {
                id: "GB",
                value: 64100000
            }]
        }],
        brush : [{
            type : "map.bubble",
            min : 5,
            max : 50,
            colors : function(d) {
                if(d.value > 1000000000) {
                    return "linear(top) #ff686c,0.9 #fa5559";
                } else if(d.value > 100000000) {
                    return "linear(top) #ff9d46,0.9 #ff7800";
                } else if(d.value > 50000000) {
                    return "linear(top) #b76fef,0.9 #9228e4";
                }

                return "linear(top) #9694e0,0.9 #7977C2";
            }
        }, {
            type : "map.selector",
            activeEvent : "map.click"
        }],
        widget : [{
            type : "map.control",
            align : "start",
            orient : "top",
            dx : 10,
            dy : 10
        }, {
            type : "map.tooltip",
            format : function(obj) {
                if(obj.data.id == "south korea") {
                    return "Korea";
                }

                return obj.data.id;
            }
        }],
        style: {
            mapPathBorderWidth: 0.5
        }
    });

    var status = builder("#status", {
        padding : 25,
        axis : [{
            c : {
                type : "table",
                rows : 1,
                columns : 3,
                padding : 10
            },
            data : [
                { title : "Overall Visits", value : 192, max : 200, min : 0 },
                { title : "Mobile Visits", value : 75, max : 100, min : 0 },
                { title : "Desktop Visits", value : 25, max : 100, min : 0 }
            ]
        }],
        brush : [{
            type : "fullgauge",
            size : 10,
            titleX : -55,
            format : function(value, index) {
                if(index == 0) {
                    return value + "k";
                }

                return value + "%";
            }
        }]
    });

    _.resize(windowResize, 100);

    // Data update
    setInterval(function() {
        var domain = fiveMinBeforeTime();

        // 1. Active Service
        dashboard.axis(0).update(getDataForActiveService());

        // 2. Response Time
        var responseTimeData = dashboard.axis(1).data;
        dashboard.axis(1).set("x", { domain: domain });

        if(responseTimeData.length == 0) {
            dashboard.axis(1).update(getDataForResponseTime(300));
        } else if(responseTimeData.length == 300) {
            responseTimeData.shift();
            responseTimeData.push(getDataForResponseTime(1)[0]);
            dashboard.axis(1).update(responseTimeData);
        }

        // 3. TPS
        var tpsData = dashboard.axis(2).data;
        dashboard.axis(2).set("x", { domain: domain });

        if(tpsData.length == 0) {
            dashboard.axis(2).update(getDataForTPS(300));
        } else if(tpsData.length == 300) {
            tpsData.shift();
            tpsData.push(getDataForTPS(1)[0]);
            dashboard.axis(2).update(tpsData);
        }

        // 6. Transaction
        setTransactionData(dashboard.axis(7).data, domain);
        dashboard.axis(7).set("x", { domain: domain });

        dashboard.render();
    }, 1000);
});
</script>
</head>
<body class="jui">
<div class="navbar">
    <a class="btn small"><i class="icon-search"></i> Mini button</a>
    <a class="btn small"> Mini button</a>
</div>
<div class="row">
    <div class="col" style="width: 49%;">
        <div class="panel">
            <div class="head">
                <strong>System dashboard</strong>
            </div>
            <div class="body">
                <div id="dashboard"></div>
            </div>
        </div>
    </div>
    <div class="col" style="left: 1%; width: 50%;">
        <div class="row">
            <div class="panel">
                <div class="head">
                    <strong>Visitor location map</strong>
                </div>
                <div class="body">
                    <div id="map"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="panel">
                <div class="head">
                    <strong>Visitor status</strong>
                </div>
                <div class="body">
                    <div id="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>