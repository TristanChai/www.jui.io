<!DOCTYPE HTML>
<html>
<head>
<META charset="UTF-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="../../lib/jui/css/ui.min.css" />
<link rel="stylesheet" href="../../lib/jui/css/ui-jennifer.min.css" />
<link rel="stylesheet" href="../../lib/jui/css/grid.min.css" />
<link rel="stylesheet" href="../../lib/jui/css/grid-jennifer.min.css" />
<script type="text/javascript" src="../../lib/jquery-1.8.0.min.js" ></script>
<script type="text/javascript" src="../../lib/jui/js/core.js" ></script>
<script type="text/javascript" src="../../lib/jui/js/ui.min.js" ></script>
<script type="text/javascript" src="../../lib/jui/js/grid.min.js" ></script>
<script type="text/javascript" src="../../lib/jui/js/chart.min.js" ></script>
<script type="text/javascript" src="data.js" ></script>
<link rel="stylesheet" href="index.css" />

<script>
var filteredData = [],
	filters = [
		{ gain: false, loss: false },
		{ 1: false, 2: false, 3: false, 4: false },
		{ day: null }
	];

(function initData() {
	for(var i = 0, len = originData.length; i < len; i++) {
		var d = originData[i];

		d.date = new Date(d.date);
		d.close = +d.close; // coerce to number
		d.open = +d.open;

		var v = (d.open + d.close) / 2;
		d.total = v;
		d.avg = v / 2;

		// Quarter
		var month = d.date.getMonth();
		if (month <= 2) {
			d.quarter = 1;
		} else if (month > 2 && month <= 5) {
			d.quarter = 2;
		} else if (month > 5 && month <= 8) {
			d.quarter = 3;
		} else {
			d.quarter = 4;
		}

		// Day Of Week
		d.day = d.date.getDay();
	}
})();

function getPerformanceData(start, end) {
	var data = (filteredData.length == 0) ? originData : filteredData,
		result = [],
		cache = {}

	for(var i = start; i <= end; i++) {
		var v = data[i],
			y = v.date.getFullYear(),
			p = cache[y];

		if(!p) {
			p = {
				year: y,
				count: 0,
				absGain: 0,
				fluctuation: 0,
				sumIndex: 0,
				avgIndex: 0,
				percentageGain: 0,
				fluctuationPercentage: 0
			};
		}

		++p.count;
		p.absGain += v.close - v.open;
		p.fluctuation += Math.abs(v.close - v.open);
		p.sumIndex += (v.open + v.close) / 2;
		p.avgIndex = p.sumIndex / p.count;
		p.percentageGain = p.avgIndex ? (p.absGain / p.avgIndex) * 100 : 0;
		p.fluctuationPercentage = p.avgIndex ? (p.fluctuation / p.avgIndex) * 100 : 0;

		cache[y] = p;
	}

	for(var key in cache) {
		result.push(cache[key]);
	}

	return result;
}

function getLossAndGainData(start, end) {
	var data = (filteredData.length == 0) ? originData : filteredData,
		result = [{
			loss: 0,
			gain: 0
		}];

	for(var i = start; i <= end; i++) {
		if(data[i].open > data[i].close) {
			result[0].loss += 1;
		} else {
			result[0].gain += 1;
		}
	}

	result[0].loss = Math.round(result[0].loss / (end - start) * 100);
	result[0].gain = Math.round(result[0].gain / (end - start) * 100);

	return result;
}

function getQuarterData(start, end) {
	var data = (filteredData.length == 0) ? originData : filteredData,
		result = [{
			1: 0,
			2: 0,
			3: 0,
			4: 0
		}];

	for(var i = start; i <= end; i++) {
		result[0][data[i].quarter] += 1;
	}

	return result;
}

function getDayOfWeekData(start, end) {
	var data = (filteredData.length == 0) ? originData : filteredData,
		keys = [ "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
		result = [];

	for(var i = 0; i < keys.length; i++) {
		result.push({
			day: i,
			dayStr: keys[i],
			value: 0
		});
	}

	for(var i = start; i <= end; i++) {
		result[data[i].day].value += 1;
	}

	result.shift();
	result.pop();

	return result;
}

function getFluctuationData(start, end) {
	var data = (filteredData.length == 0) ? originData : filteredData,
		result = [],
		cache = {};

	for(var i = start; i <= end; i++) {
		var per = Math.round((data[i].close - data[i].open) / data[i].open * 100);

		if(!cache[per]) {
			cache[per] = 0;
		}

		cache[per] += 1;
	}

	for(var key in cache) {
		result.push({
			percent: parseInt(key),
			count: cache[key]
		});
	}

	return result;
}

function getDailyTableData(start, end) {
	var _ = jui.include("util.base"),
		data = (filteredData.length == 0) ? originData : filteredData,
		result = [];

	for(var i = start; i <= end; i++) {
		var d = _.extend({
			date: _.dateFormat(data[i].date, "yyyy-MM-dd"),
			change: (data[i].close - data[i].open).toFixed(2)
		}, data[i], true);

		result.push(d);
	}

	return result;
}

jui.ready([ "util.base", "util.time", "chart.builder", "grid.xtable" ], function(_, time, builder, xtable) {
	var performanceChart = builder("#yearly_performance", {
		height : 250,
		padding : {
			left : 65,
			right : 50,
			top : 25,
			bottom : 40
		},
		axis : [{
			x : {
				type : "range",
				domain : [ -2000, 2000 ],
				unit : 500,
				line : "solid",
				key : "absGain"
			},
			y : {
				type : "range",
				domain : [ -150, 150 ],
				unit : 50,
				format : function(v) {
					return v + "%";
				},
				line : "solid"
			}
		}],
		brush : [{
			type : "bubble",
			target : "percentageGain"
		}],
		widget : [{
			type : "title",
			text : "Index Gain (%)",
			align : "start",
			orient : "center",
			dx : -75
		}, {
			type : "title",
			text : "Index Gain",
			orient : "bottom",
			dy : 12
		}],
		style : {
			titleFontSize : 11,
			titleFontWeight : "bold"
		},
		render : false
	});

	var summaryChart = builder("#summary_info", {
		padding : {
			left : 0
		},
		height : 250,
		axis : [{
			area : {
				width : "20%"
			}
		}, {
			area : {
				width : "20%",
				x : "18%"
			}
		}, {
			area : {
				width : "20%",
				x : "40%"
			},
			x : {
				type : "range",
				domain : function(d) {
					return d.value * 1.2
				},
				step : 1,
				reverse : true,
				line : "solid"
			},
			y : {
				type : "block",
				domain : "dayStr",
				orient : "right",
				line : "solid"
			}
		}, {
			area : {
				width : "32%",
				x : "68%"
			},
			x : {
				type : "range",
				domain : [ -25, 25 ],
				key : "percent",
				step : 10,
				format : function(v) {
					return v + "%";
				}
			},
			y : {
				type : "range",
				domain : [ 0, 2500 ],
				step : 5,
				orient : "right",
				line : "solid"
			}
		}],
		brush : [{
			type : "pie",
			showText : "inner",
			activeEvent : "click",
			format : function(k, v) {
				var res = "";

				if(k == "loss") res = "Loss";
				else res = "Gain";

				return res + " (" + v + "%)";
			},
			axis : 0
		}, {
			type : "donut",
			showText : "inner",
			activeEvent : "click",
			format : function(k, v) {
				if(k == 1) return "Q1";
				else if(k == 2) return "Q2";
				else if(k == 3) return "Q3";
				else if(k == 4) return "Q4";
			},
			axis : 1
		},  {
			type : "bar",
			activeEvent : "click",
			target : [ "value" ],
			axis : 2
		},  {
			type : "column",
			size : 5,
			axis : 3
		}],
		widget : [{
			type : "title",
			text : "Days by Gain/Loss",
			orient : "bottom",
			dy : 50,
			axis : 0
		}, {
			type : "title",
			text : "Quarters",
			orient : "bottom",
			dy : 50,
			axis : 1
		}, {
			type : "title",
			text : "Day of Week",
			orient : "bottom",
			dy : 50,
			axis : 2
		}, {
			type : "title",
			text : "Days by Fluctuation",
			orient : "bottom",
			dy : 50,
			axis : 3
		}, {
			type : "tooltip",
			orient : "right",
			brush : [ 0, 1, 2 ],
			format : function(v, k) {
				return v[k];
			}
		}, {
			type : "cross",
			xFormat : function(d) {
				return Math.ceil(d) + "%";
			},
			yFormat : function(d) {
				return Math.ceil(d);
			},
			axis : 3
		}],
		style : {
			titleFontSize : 11,
			titleFontWeight : "bold",
			gridTickBorderSize : 0,
			gridActiveFontColor : "#333"
		},
		event : {
			click: function(obj, e) {
				var filter = filters[obj.brush.index];

				if(obj.brush.index < 2) {
					filter[obj.dataKey] = !filter[obj.dataKey];
				} else {
					filter["day"] = obj.data.day;
				}
			}
		},
		render : false
	});

	var volumeChart = builder("#monthly_index", {
		padding : {
			top : 25,
			bottom : 90
		},
		width : "100%",
		height : 300,
		axis : [{
			x : {
				type : "date",
				domain : [ originData[0].date, originData[originData.length - 1].date ],
				interval : time.DAY * 365,
				format : "yyyy",
				key : "date",
				line : "solid"
			},
			y : {
				type : "range",
				domain: [ 0, 3000 ],
				step : 4,
				line : false,
				color : 2
			},
			start : 2000,
			end : 3000
		}, {
			extend : 0,
			x : {
				hide : true
			},
			y : {
				type : "range",
				domain: [ 0, 7000 ],
				step : 7,
				line : false,
				orient : "right",
				color : 0
			}
		}],
		brush : [{
			type : "area",
			line : "solid",
			target : [ "avg" ],
			colors : [ 2 ],
			axis : 0
		}, {
			type : "area",
			line : "solid",
			target : [ "total" ],
			axis : 1
		}],
		widget : [{
			type : "zoomscroll",
			key : "total",
			dy : 30,
			format : function(d, i) {
				return time.format(d, "yyyy");
			},
			axis : 1
		}],
		event : {
			"zoomscroll.dragend": function(start, end) {
				var domain = {
					domain: [ originData[start].date, originData[end].date ]
				};

				this.axis(0).set("x", domain);
				this.axis(1).set("x", domain);

				updateAll(start, end);
			}
		},
		style : {
			areaBackgroundOpacity : 0.75
		},
		render : false
	});

	var stock_table = xtable("#stock_table", {
		fields: [ "date", "open", "close", "change", "volume" ],
		resize: true,
		sort: true,
		buffer: "scroll",
		bufferCount: 20
	});

	// Initialize Data
	volumeChart.axis(0).update(originData);
	volumeChart.axis(1).update(originData);
	volumeChart.render(true);
	updateAll(0, originData.length - 1);

	// Updates for the Data Range
	function updateAll(start, end) {
		var performanceData = getPerformanceData(start, end),
			lossAndGainData = getLossAndGainData(start, end),
			quarterData = getQuarterData(start, end),
			dayOfWeekData = getDayOfWeekData(start, end),
			fluctuationData = getFluctuationData(start, end),
			dailyTableData = getDailyTableData(start, end);

		performanceChart.axis(0).update(performanceData);
		performanceChart.render();

		summaryChart.axis(0).update(lossAndGainData);
		summaryChart.axis(1).update(quarterData);
		summaryChart.axis(2).update(dayOfWeekData);
		summaryChart.axis(3).update(fluctuationData);
		summaryChart.render();

		stock_table.update(dailyTableData);
	}
});
</script>
</head>
<body class="jui">

<div class="row">
	<div class="panel">
		<div class="head">
			<strong>Yearly Performance</strong>
		</div>
		<div class="body">
			<div id="yearly_performance"></div>
		</div>
	</div>
</div>

<div class="row">
	<div class="panel">
		<div class="head">
			<strong>Summary Information</strong>
		</div>
		<div class="body">
			<div id="summary_info"></div>
		</div>
	</div>
</div>

<div class="row">
	<div class="panel">
		<div class="head">
			<strong>Monthly Index Abs Move & Volume Chart</strong>
		</div>
		<div class="body">
			<div id="monthly_index"></div>
		</div>
	</div>
</div>

<div class="row">
	<div class="panel">
		<div class="head">
			<strong>Daily Stock Table</strong>
		</div>
		<div id="stock_table" class="xtable">
			<table class="table classic">
				<thead>
				<tr>
					<th>Date</th>
					<th>Open</th>
					<th>Close</th>
					<th>Change</th>
					<th>Volume</th>
				</tr>
				</thead>
				<tbody></tbody>
			</table>
		</div>

		<script data-jui="#stock_table" data-tpl="row" type="text/template">
			<tr>
				<td><!= date !></td>
				<td><!= open !></td>
				<td><!= close !></td>
				<td><!= change !></td>
				<td><!= volume !></td>
			</tr>
		</script>
	</div>
</div>

</body>
</html>
