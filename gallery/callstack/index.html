
<!DOCTYPE HTML>
<html>
<head>
<META charset="UTF-8">
<title>[JUI Library] - JavaScript/Tooltip</title>

<link rel="stylesheet" href="../../lib/jui/css/ui.min.css"/>
<link rel="stylesheet" href="../../lib/jui/css/ui-jennifer.min.css"/>
<link rel="stylesheet" href="../../lib/jui/css/grid.min.css"/>
<link rel="stylesheet" href="../../lib/jui/css/grid-jennifer.min.css"/>
<script type="text/javascript" src="../../lib/jquery-1.8.0.min.js"></script>
<script type="text/javascript" src="../../lib/jui/js/core.min.js"></script>
<script type="text/javascript" src="../../lib/jui/js/ui.min.js"></script>
<script type="text/javascript" src="../../lib/jui/js/grid.min.js"></script>
<script type="text/javascript" src="../../lib/jui/js/chart.min.js"></script>
<link rel="stylesheet" href="../../gallery/callstack/index.css"/>
<link rel="stylesheet" href="../../gallery/callstack/index.jennifer.css"/>

<script>
function getActiveIndexForTimeline(data) {
	var index = -1,
		max = 0;

	for(var i = 0; i < data.length; i++) {
		var rangeWidth = data[i].etime - data[i].stime;

		if(max < rangeWidth) {
			max = rangeWidth;
			index = i;
		}
	}

	return index;
}

jui.define("grid.calltree", [ "grid.xtable", "ui.window", "ui.dropdown" ], function(grid_xtable, ui_win, ui_drop) {
    var CallTree = function() {
        var table = null,
            data = [],
            height = 0;

        function init() {
            table = grid_xtable("#call-tree-vs", {
                fields: [ null, null, "packageName", "className", "cpuTime", "api", "parameter", "return" ],
                colshow: getColshowListStorage().head,
                scrollWidth: $("#popTabContents").width(),
                scrollHeight: 300,
                rowHeight: 25,
                buffer: "vscroll",
                resize: true,
                event: {
                    colshow: function(column) {
                        setTimeout(function() {
                            localStorage.setItem("callTreeColshow", getColshowList());
                        }, 100);
                    },
                    colhide: function(column) {
                        setTimeout(function() {
                            localStorage.setItem("callTreeColshow", getColshowList());
                        }, 100);
                    },
                    select: function(row, e) {
                        var $elem = $(e.target);

                        if($elem.hasClass("btn-sql")) {
                            return;
                        } else if($elem.hasClass("btn-thread")) {
                            return;
                        } else if($elem.hasClass("btn-dbconn")) {
                            return;
                        }

                        // 자식 노드 열기/닫기
                        if(row.children.length > 0) {
                            if (row.type == "fold") {
                                this.open(row.index);
                            } else {
                                this.fold(row.index);
                            }
                        }

                        this.select(row.index);
                    },
                    rowmenu: function(row, e) {
                    }
                }
            });
        }

        function getColshowList() {
            var result = [],
				cols = table.listColumn();

            for(var i = 0; i < cols.length; i++) {
                if(cols[i].type == "show") {
                    result.push(cols[i].index);
                }
            }

            return result.join(",");
        }

        function getColshowListStorage() {
            var colshow = localStorage.getItem("callTreeColshow"),
                result = {
                    head: [ 0, 1, 2, 3 ],
                    right: []
                };

            if(colshow != null) {
                var tmpList = colshow.split(",");

                if(tmpList.length > 0) {
                    result.head = [];
                    result.right = [];
                }

                for(var i = 0; i < tmpList.length; i++) {
                    result.head.push(parseInt(tmpList[i]));
                }
            }

            for(var j = 0; j < result.head.length; j++) {
                var index = result.head[j];

                if(index > 0) {
                    result.right.push(index - 1);
                }
            }

            return result;
        }

        function openParentRow(row) {
            row.type = "open";

            if(row.depth > 1) {
                openParentRow(row.parent);
            }
        }

        this.updateTree = function(tree) {
			data = [];

			for(var i = 0, len = tree.length; i < len; i++) {
				data.push({
					type: (i == 0) ? "open" : "fold",
					index: tree[i].treeIndex,
					data: tree[i]
				})
			}

            data[0].data.timePer = 100;
            table.updateTree(data);
        }

        this.searchProfile = function(obj) {
            if(obj == null || data.length == 0) return;

            var matchingList = obj.matchingCallTreeNodeKeyList,
                passingList = obj.passingCallTreeNodeKeyList,
                openRows = {},
                maxRow = null,
                updateRow = function(d) {
                    if(!openRows[d.treeIndex]) {
                        openRows[d.treeIndex] = table.get(d.treeIndex);
                    }

                    if(maxRow == null || d.time > maxRow.data.time) {
                        maxRow = openRows[d.treeIndex];
                    }
                };

            for(var i = 0; i < data.length; i++) {
                var d = data[i].data;

                d.matching = false;
                d.passing = false;

                if ($.inArray(d.nodeKey, matchingList) != -1) {
                    d.matching = true;
                    updateRow(d);
                }

                if ($.inArray(d.nodeKey, passingList) != -1) {
                    d.passing = true;
                    updateRow(d);
                }
            }

            for(var key in openRows) {
                openParentRow(openRows[key]);
            }

            table.scrollTop(maxRow.index);
        }

        this.append = function(index, data) {
            table.append(index, data);
        }

        this.size = function() {
            return table.size();
        }

        this.hideColumn = function(index) {
            table.hideColumn(index);
        }

        this.showColumn = function(index) {
            table.showColumn(index);
        }

        this.toggleColumnMenu = function() {
            var offset = $(table.root).offset();
            table.toggleColumnMenu($(table.root).width() - 160, offset.top - 10);
        }

        this.reset = function() {
            table.reset();
        }

        this.height = function(h) {
            height = h;
            table.scrollHeight(h);
        }

        this.increaseHeight = function(h) {
            this.height(height + h);
        }

        this.decreaseHeight = function(h) {
            this.height(height - h);
        }

        this.openRoot = function() {
            table.open("0");
        }

        this.foldRoot = function() {
            table.fold("0");
        }

        this.openAll = function() {
            table.openAll("0");
        }

        this.foldAll = function() {
            table.foldAll("0");
        }

        this.getPercent = function(time) {
            var per = Math.round((time / table.getData(0).time) * 100),
                timePer = isNaN(per) ? 0 : per;

            return timePer;
        }

        init();
    }

    return CallTree;
});

jui.ready([ "util.base", "grid.calltree", "chart.builder" ], function(_, CallTreeTable, builder) {
	window.callTree = new CallTreeTable();

	window.timeline = builder("#timeline", {
		height : 76,
		padding : 0,
		axis : {
			x : {
				type : "range",
				domain : "etime",
				step : 20,
				hide : true
			},
			y : {
				domain : [ "Name", "Method", "Sql", "ExternalCall" ],
				hide : true,
				format : function(d) {
					if(d == "Sql") return "SQL";
					else if(d == "ExternalCall") return "External Call";

					return d;
				}
			},
			padding : {
				left : 100
			},
			keymap : {
				key : "type"
			}
		},
		brush : [{
			type : "timeline",
			active : 0,
			barSize : 7,
			lineWidth : 1,
			target : [ "stime", "etime" ],
			colors : function(d) {
				return "#4dbfd9";
			}
		}],
		event : {
			"timeline.active" : function(d, e) {
				if(d === -1) return;
				callTree.searchProfile(d);
			}
		},
		render : false
	});

    $.getJSON("data/calltree_heavy.json", function(json) {
        callTree.updateTree(json.list);

		$.getJSON("data/timeline_heavy.json", function(json) {
			var index = getActiveIndexForTimeline(json.list);

			if(index > -1) {
				timeline.updateBrush(0, {
					active: index
				});

				callTree.searchProfile(json.list[index]);
			}

			timeline.axis(0).update(json.list);
			timeline.render();
		});
    });
});

</script>
</head>
<body class="jui popup">

<div class="row" style="padding: 10px;">
	<div id="timeline"></div>
</div>

<div class="row" style="padding: 10px; text-align: right;">
	<a class="btn  small" onclick="callTree.toggleColumnMenu();">
		<i class="icon-column"></i> 테이블 컬럼보기
	</a>
</div>

<div class="xviewPointList">
    <div id="popTabContents">
        <div id="call-tree-vs" class="xtable scroll">
            <table id="call-tree-head" class="table simple headline nowrap">
                <thead>
                <tr>
                    <th width="50%">프로파일 명</th>
                    <th>응답시간 (ms)</th>
                    <th>패키지</th>
                    <th>클래스</th>
                    <th>CPU 시간 (ms)</th>
                    <th>API</th>
                    <th>매개변수</th>
                    <th>반환값</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>


<script data-vo="#call-tree-vs" data-tpl="row" type="text/template">
<! var timePer = callTree.getPercent(time) !>

<tr data-index="<!= row.index !>" class="<! if(iconType.toLowerCase() == "not_profiled") { !>not-focus<! } !> <! if(typeof(matching) != "undefined" && matching) { !>selected-bold<! } !> <! if(typeof(passing) != "undefined" && passing) { !>selected-light<! } !>">
    <td>
        <span style="display: inline-block; width: <!= row.depth * 20 !>px"></span>

        <! if(!leaf) { !>
        <i class="rowStatus icon-<! if(row.type != "open") { !>left<! } else { !>right<! } !>"></i>
        <! } else { !>
        <i class="icon-blank"></i>
        <! } !>

        <i class="ico-calltree <!= iconType.toLowerCase() !>"></i>

        <! if(sql != "") { !>
					<span title="<!= sql !>"><span class="btn-sql">[SQL보기]</span>
					<!= sql !></span>
        <! } else if(threadId != "") { !>
					<span title="<!= description !>"><span class="btn-thread">[스레드보기]</span>
					<!= description !></span>
        <! } else if(detailMessageOrEmpty != "") { !>
					<span title="<!= description !>"><span class="btn-dbconn">[상세보기]</span>
					<!= description !></span>
        <! } else { !>
        <span title="<!= description !>"><!= description !></span>
        <! } !>
    </td>
    <td align="right">
        <! if(timeEnabled) { !>
        <div class="time-layout">
            <div class="time"><!= time !></div>
            <div class="time-bar">
                <div class="time-bar-per" style="width: <!= timePer !>%;"></div>
                <div class="time-bar-text"><!= timePer !>%</div>
            </div>
        </div>
        <! } !>
    </td>
    <td title="<!= packageName !>"><!= packageName !></td>
    <td title="<!= className !>"><!= className !></td>
    <td align="right">
        <! if(timeEnabled) { !>
        <!= (cpuTime == -1) ? "" : cpuTime !>
        <! } !>
    </td>
    <td title="<!= api !>"><!= api !></td>
    <td title="<!= parameter !>"><!= parameter !></td>
    <td title="<!= row.data["return"] !>"><!= row.data["return"] !></td>
</tr>
</script>

<script data-vo="#call-tree-vs" data-tpl="menu" type="text/template">
    <div class="dropdown">
        <div class="anchor" style="left: 122px;"></div>

        <ul style="width: 150px;">
            <! for(var i = 0; i < columns.length; i++) { !>
            <li <! if(i == 0 || i == 1) { !>style="display: none"<! } !>>
            <input type="checkbox" />&nbsp; <!= columns[i] !>
            </li>
            <! } !>
        </ul>
    </div>
</script>

</body>
</html>
